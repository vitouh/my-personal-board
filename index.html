<h3>Comment Section</h3>
<input type="text" id="userName" placeholder="Your name"><br>
<textarea id="newComment" placeholder="Write a comment..." style="width:100%;height:80px;font-size:14px;"></textarea><br>
<button onclick="addComment()">Post Comment</button>
<div id="comments"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config (use yours)
const firebaseConfig = {
  apiKey: "AIzaSyBUxo-7rLsYMjjOSQDYczqwcrh_pyX7D1o",
  authDomain: "vito-board.firebaseapp.com",
  projectId: "vito-board",
  storageBucket: "vito-board.firebasestorage.app",
  messagingSenderId: "15417026348",
  appId: "1:15417026348:web:0b5f8ed7b101af0c842e89"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const commentsDiv = document.getElementById('comments');
const commentBox = document.getElementById('newComment');
const nameBox = document.getElementById('userName');

// Visitor ID
let visitorID = localStorage.getItem('visitorID');
if(!visitorID) {
  visitorID = crypto.randomUUID();
  localStorage.setItem('visitorID', visitorID);
}

// Load comments
const commentsCol = collection(db, "comments");
const q = query(commentsCol, orderBy("timestamp", "asc"));
onSnapshot(q, (snapshot) => {
  commentsDiv.innerHTML = "";
  const commentsData = [];
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    commentsData.push({id: docSnap.id, ...data});
  });

  // Display top-level comments
  commentsData.filter(c => !c.parentID).forEach(c => {
    renderComment(c, commentsData, commentsDiv, 0);
  });
});

// Render comment and its replies recursively
function renderComment(comment, allComments, container, level) {
  const div = document.createElement('div');
  div.style.border = '2px solid #aaa';
  div.style.padding = '6px';
  div.style.margin = '6px 0 6px ' + (level*20) + 'px';
  div.style.fontSize = '14px';
  div.style.backgroundColor = '#f6efe8';

  div.textContent = `${comment.name || "Anonymous"}: ${comment.text}`;

  // Delete button
  if(comment.userID === visitorID){
    const delBtn = document.createElement('button');
    delBtn.textContent = "Delete";
    delBtn.className = "delete-btn";
    delBtn.onclick = async () => {
      await deleteDoc(doc(db, "comments", comment.id));
    };
    div.appendChild(delBtn);
  }

  // Reply button
  const replyBtn = document.createElement('button');
  replyBtn.textContent = "Reply";
  replyBtn.style.marginLeft = '8px';
  replyBtn.onclick = () => {
    if(div.querySelector('.reply-box')) return; // prevent multiple boxes
    const replyDiv = document.createElement('div');
    replyDiv.className = 'reply-box';
    replyDiv.style.marginTop = '4px';
    const replyName = document.createElement('input');
    replyName.placeholder = 'Your name';
    replyName.style.width = '150px';
    const replyText = document.createElement('textarea');
    replyText.placeholder = 'Write a reply...';
    replyText.style.width = '100%';
    replyText.style.height = '50px';
    const sendBtn = document.createElement('button');
    sendBtn.textContent = 'Post Reply';
    sendBtn.onclick = async () => {
      const text = replyText.value.trim();
      if(!text) return;
      await addDoc(collection(db, "comments"), {
        text: text,
        name: replyName.value.trim() || 'Anonymous',
        timestamp: serverTimestamp(),
        userID: visitorID,
        parentID: comment.id
      });
      replyDiv.remove();
    }
    replyDiv.appendChild(replyName);
    replyDiv.appendChild(replyText);
    replyDiv.appendChild(sendBtn);
    div.appendChild(replyDiv);
  }
  div.appendChild(replyBtn);

  container.appendChild(div);

  // Render replies
  allComments.filter(c => c.parentID === comment.id)
             .forEach(c => renderComment(c, allComments, container, level+1));
}

// Post new comment
window.addComment = async function() {
  const text = commentBox.value.trim();
  if(!text) return;
  await addDoc(collection(db, "comments"), {
    text: text,
    name: nameBox.value.trim() || "Anonymous",
    timestamp: serverTimestamp(),
    userID: visitorID
  });
  commentBox.value = '';
  nameBox.value = '';
}
</script>
